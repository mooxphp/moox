!function(){const{__}=wp.i18n,{useState:e,useEffect:t,useRef:n}=wp.element,{useSelect:o}=wp.data,{InspectorControls:l,MediaUpload:r,MediaUploadCheck:a,useBlockProps:m}=wp.blockEditor,{PanelBody:c,Button:i,TextControl:p,SelectControl:s,Placeholder:d,Spinner:w,__experimentalVStack:u}=wp.components;wp.blocks.registerBlockType("moox/bpmn-viewer",{title:__("BPMN Viewer","moox-bpmn"),icon:"chart-line",category:"media",description:__("Upload, view, and edit BPMN 2.0 models","moox-bpmn"),supports:{html:!1,lock:{move:!1}},attributes:{mediaId:{type:"number",default:0},mode:{type:"string",default:"view"},height:{type:"string",default:"500px"}},edit:function(b){const{attributes:h,setAttributes:x}=b,{mediaId:v,mode:E,height:g}=h,[f,y]=e(""),[B,N]=e(!1),[k,P]=e(!1),M=n(null),C=n(null),S=o(e=>v?e("core").getEntityRecord("postType","attachment",v,{context:"view"}):null,[v]);t(()=>{S?.source_url&&(P(!0),fetch(S.source_url).then(e=>e.text()).then(e=>{y(e),P(!1)}).catch(e=>{console.error("Error loading BPMN:",e),P(!1)}))},[S]),t(()=>{if(!M.current||!f||"function"!=typeof window.renderGutenbergBpmn)return;M.current.innerHTML="";const e=B&&"edit"===E?"edit":"view";window.renderGutenbergBpmn(M.current,f,e).then(e=>{C.current=e}).catch(e=>console.error("Renderer error:",e))},[f,B,E]);const _=m({className:"moox-bpmn-block-editor"});return wp.element.createElement("div",_,wp.element.createElement(l,null,wp.element.createElement(c,{title:__("BPMN Settings","moox-bpmn")},wp.element.createElement(u,{spacing:3},wp.element.createElement(s,{label:__("Mode","moox-bpmn"),value:E,options:[{label:__("View Only","moox-bpmn"),value:"view"},{label:__("Edit","moox-bpmn"),value:"edit"}],onChange:e=>x({mode:e})}),wp.element.createElement(p,{label:__("Height","moox-bpmn"),value:g,onChange:e=>x({height:e})})))),!v&&wp.element.createElement(d,{icon:"chart-line",label:__("BPMN Viewer","moox-bpmn"),instructions:__("Select a BPMN (.bpmn or .xml) file","moox-bpmn")},wp.element.createElement(a,null,wp.element.createElement(r,{onSelect:e=>x({mediaId:e.id}),allowedTypes:["application/xml","text/xml"],value:v,render:({open:e})=>wp.element.createElement(i,{variant:"primary",onClick:e},__("Select BPMN File","moox-bpmn"))}))),v&&wp.element.createElement("div",{className:"moox-bpmn-preview"},wp.element.createElement("div",{className:"moox-bpmn-preview-header"},wp.element.createElement("div",{className:"moox-bpmn-file-info"},wp.element.createElement("strong",null,S?.title?.rendered||S?.filename||__("Selected File","moox-bpmn")),"edit"===E&&wp.element.createElement(i,{variant:B?"primary":"secondary",onClick:()=>N(!B)},__(B?"Preview":"Edit","moox-bpmn"))),wp.element.createElement(i,{variant:"secondary",onClick:()=>x({mediaId:0})},__("Change File","moox-bpmn"))),wp.element.createElement("div",{className:"moox-bpmn-preview-content",style:{height:g}},k?wp.element.createElement(w,null):wp.element.createElement("div",{ref:M,style:{width:"100%",height:"100%"}})),B&&"edit"===E&&wp.element.createElement("div",{className:"moox-bpmn-editor-toolbar"},wp.element.createElement(i,{variant:"primary",onClick:()=>{if(!v||!f)return;const e=new FormData;e.append("action","moox_bpmn_save"),e.append("mediaId",v),e.append("bpmnContent",f),e.append("nonce",mooxBpmnBlock.nonce),fetch(mooxBpmnBlock.ajaxUrl,{method:"POST",body:e}).then(e=>e.json()).then(e=>{e.success?(wp.data.dispatch("core/notices").createNotice("success",__("BPMN file saved successfully","moox-bpmn"),{type:"snackbar"}),N(!1)):wp.data.dispatch("core/notices").createNotice("error",__("Error saving BPMN file","moox-bpmn"),{type:"snackbar"})}).catch(e=>{console.error("Error saving BPMN:",e),wp.data.dispatch("core/notices").createNotice("error",__("Error saving BPMN file","moox-bpmn"),{type:"snackbar"})})}},__("Save Changes","moox-bpmn")))))},save:()=>null})}();