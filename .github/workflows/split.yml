name: Split

on:
  workflow_dispatch:
    inputs:
      version:
        description: "New version"
        required: true
      packages: 
        description: "Packages to deploy (JSON array string)"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Show input
        run: |
          echo "Deploying version: ${{ github.event.inputs.version }}"
          echo "Packages received"
          
      - name: Parse packages safely
        id: parse_packages
        run: |
          # Create a temp file to avoid shell injection
          cat > packages.json << 'EOF'
          ${{ github.event.inputs.packages }}
          EOF
          
          echo "Raw packages file:"
          cat packages.json
          
          echo "Parsed packages:"
          jq -r 'to_entries[] | "\(.key): \(.value | join(", "))"' packages.json
          
          # Create package list for later steps
          jq -r 'keys[]' packages.json > package-list.txt
          
          echo "Package names only:"
          cat package-list.txt

      - name: Process each package
        run: |
          while IFS= read -r package; do
            echo "Processing package: $package"
            
            # Get messages for this package
            messages=$(jq -r --arg pkg "$package" '.[$pkg] | join("; ")' packages.json)
            echo "Messages: $messages"
            
            # Your deployment logic here
            # e.g., clone repo, create release, etc.
            
          done < package-list.txt
